<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">

	<head>
		<title></title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link rel="stylesheet" href="../../css/fonts/font-awesome.min.css" />
		<link rel="stylesheet" href="../../css/ui-box.css">
		<link rel="stylesheet" href="../../css/ui-base.css">
		<link rel="stylesheet" href="../../css/ui-color.css">
		<link rel="stylesheet" href="../../css/appcan.icon.css">
		<link rel="stylesheet" href="../../css/appcan.control.css">
		<link rel="stylesheet" href="../../css/main.css" />
		<link rel="stylesheet" href="../../css/mobiscroll.min.css">
		<link rel="stylesheet" href="../../css/mymedia.css">
		<link rel="stylesheet" href="css/plane.css">
        <script type="text/javascript" src="../../js/setSkin.js"></script>
		<style>
			#header, #dateList{position: initial;}
			.longlist{overflow-y:auto;-webkit-overflow-scrolling:touch;}
		</style>
	</head>

	<body class="um-vp sc-bg-active ub ub-ver" ontouchstart>
	    	<div id="header" class="uh ub header-bg plane-list-header">
                <div class="nav-btn back" id="nav-left">
                    <div class="ub-img user-icon-goback umw1-5 umh4"></div>
                </div>
                <div class="ub ub-ver ub-f1 title">
                    <div class="ub ub-ac ub-pc ub-f1 ulev-3 ut-s tx-c">
						<span id="isBack"></span>
                        <div id="depPlane">北京</div>
                        <div class="head-icon ub-img"></div>
                        <div id="arrPlane">上海</div>
                    </div>
                </div>
                <div class="nav-btn nav-bt icon-act" id="nav-right">
                    <a class="ub-img user-icon-phone umw1-5 umh4 ub ub-ac" href="tel:02086132900"></a>
                </div>
            </div>
            <div class="ub ub-ac header-bg train-t-head" id="dateList">
                <div class="train-t-prev ub ub-ac" id="prevDay">
                    <div class="fa fa-2x fa-angle-left"></div>
                    <div class="arrow">
                        前一天
                        <div class="arrow-price" id="prevDayPrice"></div>
                    </div>
                </div>
                <div class="train-t-date ub ub-f1 ub-pc" id="dateSelect">
                    <div class="date-select ub ub-ac">
                        <div class="icon-date"></div>
                        <p class="date-text" id="today"></p>
                        <i class="fa fa-2x fa-angle-down"></i>
                    </div>
                </div>
                <div class="train-t-next ub ub-ac" id="nextDay">
                    <div class="arrow">
                        后一天
                        <div class="arrow-price" id="nextDayPrice"></div>
                    </div>
                    <div class="fa fa-2x fa-angle-right"></div>
                </div>
            </div>
       <div class="ub-f1 longlist">
			<div id="msg" class="plane-msg"></div>
			<div id="planeTicketlist">
				<ul class="plane-list-result" v-cloak>
					<li v-for='item in items' v-on:click="openRand(item)">
						<div class="info ub">
							<div>
								<p class="big">{{item.myDepDate}}</p>
								<p class="top">{{item.fromName}}{{item.depAirport}}</p>
							</div>
							<div class="ub ub-f1 ub-ac" v-if="item.stopNum <= 0">
								<div class="arrow ub-img ub-f1"></div>
							</div>
							<div v-else>
								<div class="arrow ub-img">经停</div>
								<div class="top">{{item.myStopCity}}</div>
							</div>
							<div>
								<p class="big">{{item.myArrDate}}</p>
								<p class="top">{{item.toName}}{{item.arrAirport}}</p>
							</div>
							<div>
								<div class="big red money" v-if="item.minPrice==''">无</div>
								<div class="big red money" v-else>￥{{item.minPrice}}<span class="small">起</span></div>
								<div class="top red" v-if="item.discount < 10 && item.discount > 0"><span class="small">{{item.shipping}} {{item.discount}}折</span></div>
							</div>
						</div>
						<div class="tails ub ub-ac">
							<img :src="item.logo" class="logo ub-ac ub" onerror="this.src='img/logo/logo.png'">
							<span>{{item.companyName}}{{item.carrier}}{{item.flightNo}}<span class="blue" v-if="item.shareFlight!=''"> 共享{{item.shareFlight}}</span></span>
							<span class="interval">|</span>
							<span>历时{{item.duration}}分</span>
						</div>
					</li>
				</ul>
				<div class="screen ub" id="screen">
					<div class="ub ub-f1 ub-ac ub-pc" id="departTime">
						<div>起飞时间</div>
						<div class="ub ub-ac">
							<i class="fa fa-caret-up active"></i>
							<i class="fa fa-caret-down"></i>
						</div>
					</div>
					<div class="ub ub-f1 ub-ac ub-pc" id="lowestPrice">
						<div>最低价格</div>
						<div class="ub ub-ac">
							<i class="fa fa-caret-up"></i>
							<i class="fa fa-caret-down"></i>
						</div>
					</div>
				</div>
			</div>
		</div>
		<input type="hidden" id="calendarHidden" />
	</body>
	<script src="../../js/appcan.js"></script>
	<script src="../../js/appcan.control.js"></script>

	<script src="../../js/jquery.min.js"></script>
	<script src="../../js/common.js"></script>
	<script src="js/newairport.js"></script>
	<script src="js/airPortNameMaps.js"></script>
	<script src="js/shipping.js"></script>
	<script src="../../js/mobiscroll.min.zh.js"></script>
	<script src="../../js/vue.min.js"></script>
	<script>
		var flightFromCityNode;
		var flightToCityNode;
		var airDate;
		var flightSiteType;
		var flightKeyWord;
		var app;
		var screenDir = 0; //是否是正序
		var screenType = 0; //筛选的类型
		var isReturn = false; //是否往返

		flightFromCityNode = appcan.locStorage.getVal("returnFlight")==0?appcan.locStorage.getVal("flightFromCityNode"):appcan.locStorage.getVal("flightToCityNode");
		flightToCityNode = appcan.locStorage.getVal("returnFlight")==0?appcan.locStorage.getVal("flightToCityNode"):appcan.locStorage.getVal("flightFromCityNode");
		
        if(appcan.locStorage.getVal('return')=='true'){
        	if(appcan.locStorage.getVal('returnFlight')=='0'){
        		airDate = appcan.locStorage.getVal('airDate');
        	}else if(appcan.locStorage.getVal('returnFlight')=='1'){
        		var startDate = (new Date(appcan.locStorage.getVal('airDate'))).getTime();
        		var endDate = (new Date(appcan.locStorage.getVal('backAirDate'))).getTime();
        		
        		if(startDate > endDate){
        			appcan.locStorage.setVal('backAirDate', appcan.locStorage.getVal('airDate'));
        		}
        		airDate = appcan.locStorage.getVal('backAirDate');
        	}
        }else if(appcan.locStorage.getVal('return')=='false'){
        	airDate = appcan.locStorage.getVal('airDate');
        }else{
        	airDate = NYR(new Date(), 1);
        }
        
        $("#today").text(airDate);
		$("#calendarHidden").val(airDate);
		flightSiteType = appcan.locStorage.getVal("flightSiteType");
		if(flightSiteType) {
			flightSiteType = flightSiteType.substring(0, flightSiteType.length - 1);
			if(flightSiteType != '无') {
				flightSiteType = flightSiteType.split(",");
			}
		}
		flightKeyWord = appcan.locStorage.getVal("flightKeyWord");
		
		$(function() {
			//头部初始化操作
			if(appcan.locStorage.getVal("return") == "true") {
			    if(appcan.locStorage.getVal("returnFlight")==0){
			        $("#isBack").html("往：");
			        $("#depPlane").html(appcan.locStorage.getVal("flightFromCity"));
                    $("#arrPlane").html(appcan.locStorage.getVal("flightToCity"));
			    }
				else if(appcan.locStorage.getVal("returnFlight")==1){
				    $("#isBack").html("返：");
				    $("#depPlane").html(appcan.locStorage.getVal("flightToCity"));
                    $("#arrPlane").html(appcan.locStorage.getVal("flightFromCity"));
				}
			}
			else{
			    $("#depPlane").html(appcan.locStorage.getVal("flightFromCity"));
                $("#arrPlane").html(appcan.locStorage.getVal("flightToCity"));
			}
			
		    preventClick();
			//shieldRequest(); //屏蔽公司
			screenNoClick(); //是否可以点击
			showPlaneList(); //航班列表
			getMinDatePrice(); //最低价格
			
            appcan.button("#nav-left", "btn-act", function() {
                appcan.locStorage.setVal("openFlightSearchResult", "false");
                if(appcan.locStorage.getVal("returnFlight")=="1"){
                	appcan.locStorage.setVal("returnFlight", 0);
                }else if(appcan.locStorage.getVal("returnFlight")=="0"){
                	appcan.locStorage.setVal("return", "false");
                }
				window.history.back();
            })
            appcan.button("#nav-right", "btn-act", function() {
                //uexCall.dial("02086132900");
            });

            appcan.button("#dateSelect", "btn-act", function() {
                showCalendar();
            });

            appcan.button("#prevDay", "btn-act", function() {
                prevDay();
            });

            appcan.button("#nextDay", "btn-act", function() {
                nextDay();
            });
            //头部初始化操作结束

		});

		var app = new Vue({
			el: '#planeTicketlist',
			data: {
				items: [],
			},
			methods: {
				openRand: function(item) {
                    if(appcan.locStorage.getVal("return")=="true" && appcan.locStorage.getVal("returnFlight")==1){
                        appcan.locStorage.setVal("backFlightDetail",item);
                    }
                    else{
                        appcan.locStorage.setVal("flightDetail",item);
                    }
					window.location.href = 'plane_ticket_book_content.html';
				}
			}
		});

		var planePm = {
			fromCity: flightFromCityNode,
			toCity: flightToCityNode,
			airDate: airDate,
			siteType: flightSiteType,
			cmdShare: "1",
			stopType: "ST_Direct" //ST_Nonstop("N"), 直达无经停 ST_Direct("D"), 直达有经停 ST_All("A"); 
		};

		var flightsArr = [];

		//屏蔽航司：春秋 9C。西部  PN。中联  KN。九元  AQ。成都  EU。华夏  G5。长安  9H。
		var shield = [];
		//屏蔽公司接口
		function shieldRequest() {
			appcan.request.ajax({
				url: httpHost + 'tmcDeleteFlightsController.do?all',
				beforeSend: addHeader,
				type: "POST",
				dataType: "json",
				success: function(data) {
					console.log(data);
					if(data.length > 0) {
						for(var i = 0; i < data.length; i++) {
							shield.push(data[i].flightCode);
						}
					}
				},
				error: function(err) {
					//appcan.window.openToast("网络请求异常，请检查网络是否正常。", 1000);
				}
			});
		}
		
		//渲染数据
		function showPlaneList() {
			ajaxRequest({
				url: httpHost + 'flightController.do?queryFlightsListModular',
				//beforeSend: addHeader,
				data: planePm,
				type: "POST",
				success: function(data) {console.log(data);
				    outMask();
					screenClick();
					if(data.success) {
						$("#planeTicketlist").show();
						$("#msg").hide();
						var flights = filterCode(data.obj.data.flights);
						flights = compareArrList(flights);
						if(flights && flights.length > 0) {
							for(var i = 0; i < flights.length; i++) {
								var seat = flights[i].seats;
								var logo = 'img/logo/' + flights[i].carrier + '.png';
								flights[i].companyName = airPortNameMaps[flights[i].carrier];
								flights[i].logo = logo;
								var seatArr = getMinPrice(seat);
								flights[i].minPrice = seatArr[0];
								flights[i].discount = (seatArr[1] * 1 / 10).toFixed(1);
								flights[i].shipping = seatArr[2];
								if(seatArr[2] != undefined || seatArr[2]) {
									flights[i].shipping = seatArr[2];
								} else {
									flights[i].shipping = '其他舱位';
								}
								flights[i].fromName = airPortInfos[flights[i].depart].airPortName;
								flights[i].toName = airPortInfos[flights[i].arrival].airPortName;
								var myDepDateHours = flights[i].depDate.hours < 10 ? "0" + flights[i].depDate.hours : flights[i].depDate.hours;
								var myDepDateMinutes = flights[i].depDate.minutes < 10 ? "0" + flights[i].depDate.minutes : flights[i].depDate.minutes;
								var myArrDateHours = flights[i].arrDate.hours < 10 ? "0" + flights[i].arrDate.hours : flights[i].arrDate.hours;
								var myArrDateMinutes = flights[i].arrDate.minutes < 10 ? "0" + flights[i].arrDate.minutes : flights[i].arrDate.minutes;
								flights[i].myDepDate = myDepDateHours + ':' + myDepDateMinutes;
								flights[i].myArrDate = myArrDateHours + ':' + myArrDateMinutes;
							}
						} else {
							$("#planeTicketlist").hide();
							$("#msg").show();
							$("#msg").text("查无结果或暂时无票");
						}
						flightsArr = flights;
						app.items = doOrder(flights, screenType, screenDir);
					} else {
					    outMask();
						$("#planeTicketlist").hide();
						$("#msg").show();
						if(data.msg == 'vip.yeefare.com'){
							$("#msg").text('网络信号不太好，请稍后重试。');
						}else{
							$("#msg").text(data.msg);
						}
					}

				},
				error: function(XMLHttpRequest, textStatus, errorThrown) {
					outMask();
					screenClick();
					$("#planeTicketlist").hide();
					$("#msg").show();
					$("#msg").text("网络请求异常，请检查网络是否正常");
				}
			}, "../../img/loading.gif");

			setTimeout(function() {
				screenClick();
			}, 20000);
		}

		//屏蔽不想要的航空公司
		function shieldCompany(obj) {
			if(obj) {
				if(shield.length > 0) {
					for(var j = 0; j < obj.length; j++) {
						if(shield.indexOf(obj[j].carrier) > -1) {
							obj.splice(j, 1);
							j--;
						}
					}
				}

			}

			return obj;
		}

		//过滤舱位信息
		function filterCode(arr) {
			if(flightSiteType != '无' && flightSiteType!==null) {
				for(var i = 0; i < arr.length; i++) {
					var seat = arr[i].seats;
					for(var j = 0; j < seat.length; j++) {
						if(!(flightSiteType.indexOf(seat[j].code) > -1)) {
							seat.splice(j, 1);
							j--;
						}
					}
				}
			}
			return arr;
		}

		//获取舱位最低价格
		function getMinPrice(arr) {
			var minPrice = arr[0].price;
			var discount = arr[0].sale;
			var shipping = myShipping[arr[0].code];
			for(var i = 1; i < arr.length; i++) {
				if(arr[i].price < minPrice) {
					minPrice = arr[i].price;
					discount = arr[i].sale;
					shipping = myShipping[arr[i].code];
				}
			}
			var seatArr = [minPrice, discount, shipping];
			return seatArr;
		}

		//如果舱位价格全部是空的就把这个列表去掉
		function compareArrList(arr) {
			if(arr.length > 0) {
				for(var i = 0; i < arr.length; i++) {
					var seat = compareArr(arr[i].seats);
					if(seat.length === 0) {
						arr.splice(i, 1);
						i--
					}
				}
				return arr;
			}
			return;
		}

		//去掉舱位空的价格
		function compareArr(arr) {
			if(arr.length > 0) {
				for(var i = 0; i < arr.length; i++) {
					if(arr[i].price !== "" && arr[i].price !== 0 && arr[i].price !== null) {
						continue;
					}
					arr.splice(i, 1);
					i--;
				}
				return arr;
			}
			return [];
		}

		var minPm = {
			"fCity": flightFromCityNode,
			"tCity": flightToCityNode,
			"date": airDate,
			"dayNum": 3
		};

		//获取最近三天最低价格
		function getMinDatePrice() {
			appcan.request.ajax({
				url: httpHost + "flightController.do?queryLowPriceByDate",
//				beforeSend: addHeader,
				data: minPm,
				type: "POST",
				success: function(data) {console.log(data);
					if(data.lowPrices) {
						if(data.lowPrices.length > 0) {
							appcan.locStorage.setVal("mainMInPrice", data);
							getMainMInPrice();
						}
					}
				},
				error: function(XMLHttpRequest, textStatus, errorThrown) {
					console.log(XMLHttpRequest, textStatus);
				}
			})
		}

		function prevDay() {
			var myDate = appcan.locStorage.getVal(appcan.locStorage.getVal('returnFlight')==1?'backAirDate':'airDate');
			var curDate = new Date();
			var dateText = asDay(new Date(myDate), 1, 1);
			var poor = (new Date(dateText).getTime() - (new Date(NYR(curDate, 1))).getTime());
			if(poor >= 0) {
				appcan.locStorage.setVal(appcan.locStorage.getVal('returnFlight')==1?'backAirDate':'airDate', dateText);
				airDate = dateText;
				setDate(dateText);
				$("#calendarHidden").val(dateText);
				planePm.airDate = dateText;
				preventClick();
				screenNoClick();
				minPm = {
					"fCity": flightFromCityNode,
					"tCity": flightToCityNode,
					"date": dateText,
					"dayNum": 3
				};
				getMinDatePrice();
				showPlaneList();
			} else {
				addMask('', '不能选择小于今天的日期');
				setTimeout(function(){
					removeMask();
				}, 2000);
			}
		}

		function nextDay() {
			var myDate = appcan.locStorage.getVal(appcan.locStorage.getVal('returnFlight')==1?'backAirDate':'airDate');
			var dateText = asDay(new Date(myDate), 1, 0);
			airDate = dateText;
			appcan.locStorage.setVal(appcan.locStorage.getVal('returnFlight')==1?'backAirDate':'airDate', dateText);
			setDate(dateText);
			$("#calendarHidden").val(dateText);
			planePm.airDate = dateText;
			preventClick();
			screenNoClick();
			minPm = {
				"fCity": flightFromCityNode,
				"tCity": flightToCityNode,
				"date": dateText,
				"dayNum": 3
			};
			getMinDatePrice();
			showPlaneList();
		}

		var calendarShow;

		function showCalendar() {
			var today = $("#calendarHidden").val();
			preventClick();
			screenNoClick();
			var thismin = appcan.locStorage.getVal("returnFlight")==1?new Date(appcan.locStorage.getVal("airDate")):new Date();
			calendarShow = $("#calendarHidden").mobiscroll().calendar({
				min: thismin,
				dateFormat: 'yy-mm-dd',
				defaultValue: new Date(today),
				onCancel: function(val, obj) {
				    outMask();
					screenClick();
				},
				onSet: function(val, obj) {
					val = val.valueText;
					appcan.locStorage.setVal(appcan.locStorage.getVal('returnFlight')==1?'backAirDate':'airDate', val);
					setDate(val);
					planePm.airDate = val;
					minPm = {
						"fCity": flightFromCityNode,
						"tCity": flightToCityNode,
						"date": val,
						"dayNum": 3
					};
					getMinDatePrice();
					showPlaneList();
				}
			});
			calendarShow.mobiscroll("show");
		}

		//排序
		function doOrder(datas, type, dir) {
			//type 0代表起飞时间,1代表到达时间，2最低价
			//dir 0代表正序，1代表倒叙
			var temp;
			if(datas != null && datas.length > 0) {
				for(var i = 0; i < datas.length - 1; i++) {
					for(var j = i + 1; j < datas.length; j++) {
						var value1 = getComPareValue(datas[i], type);
						var value2 = getComPareValue(datas[j], type);
						if(dir == 0) { //正序
							if(value1 > value2) {
								temp = datas[i];
								datas[i] = datas[j];
								datas[j] = temp;
							}
						} else { //d倒叙
							if(value1 < value2) {
								temp = datas[i];
								datas[i] = datas[j];
								datas[j] = temp;
							}
						}
					}
				}
			}
			return datas;
		}

		function getComPareValue(data, type) {
			var compareValue;
			var planeDate = appcan.locStorage.getVal(appcan.locStorage.getVal('returnFlight')==1?'backAirDate':'airDate');
			if(type == 0) {
				var myDepDate = new Date(NYR(planeDate, 1).replace(/-/g, "/") + ' ' + data.myDepDate).getTime();
				compareValue = myDepDate;
			} else if(type == 1) {
				var myArrDate = new Date(NYR(planeDate, 1).replace(/-/g, "/") + ' ' + data.myArrDate).getTime();
				compareValue = myArrDate;
			} else {
				compareValue = getMinPriceOrder(data.seats);
			}
			return compareValue;
		}

		function getMinPriceOrder(arr) {
			var minPrice = arr[0].price;
			for(var i = 1; i < arr.length; i++) {
				if(arr[i].price < minPrice) {
					minPrice = arr[i].price;
				}
			}
			return minPrice;
		}

		//起飞时间排序
		appcan.button("#departTime", "btn-act", function() {
			var self = $(this);
			var type = screenList(self);
			screenType = 0;
			app.items = doOrder(flightsArr, screenType, type);
		});

		//到达时间排序
		// appcan.button("#arriveTime","btn-act",function(){
		// var self = $(this);
		// var type = screenList(self);
		// screenType = 1;
		// app.items = doOrder(flightsArr,screenType,type);
		// });

		//最低价排序
		appcan.button("#lowestPrice", "btn-act", function() {
			var self = $(this);
			var type = screenList(self);
			screenType = 2;
			app.items = doOrder(flightsArr, screenType, type);
		})

		function screenList(obj) {
			var first = obj.find(".fa-caret-up").hasClass("active");
			if(first) {
				$("#screen i").removeClass("active");
				obj.find(".fa-caret-down").addClass("active");
				screenDir = 1;
			} else {
				screenDir = 0;
				$("#screen i").removeClass("active");
				obj.find(".fa-caret-up").addClass("active");
			}
			app.items = [];
			return screenDir;
		}

		//数据加载的时候不给点击筛选
		function screenNoClick() {
			$("#screen").addClass("active");
		}

		//数据加载完给点击筛选
		function screenClick() {
			$("#screen").removeClass("active");
		}
		
		//最低价格
		function getMainMInPrice() {
            var lowArr = appcan.locStorage.getVal("mainMInPrice");
            appcan.locStorage.remove("mainMInPrice")
            lowArr = JSON.parse(lowArr).lowPrices;
            if(lowArr[2].price){
                $("#prevDayPrice").text(lowArr[0].price > 0 ? '￥' + lowArr[0].price : '无');
                $("#nextDayPrice").text(lowArr[2].price > 0 ? '￥' + lowArr[2].price : '无');
            }
        }
        
        //设置日期
        function setDate(date) {
            $("#today").text(date);
        }
        //加遮罩层防止频繁点击
        function preventClick() {
            $("#dateList").addClass("active");
        }

        //去掉遮罩层
        function outMask() {
            $("#dateList").removeClass("active");
        }
	</script>

</html>