<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">

	<head>
		<title></title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link rel="stylesheet" href="../../css/fonts/font-awesome.min.css">
		<link rel="stylesheet" href="../../css/ui-box.css">
		<link rel="stylesheet" href="../../css/ui-base.css">
		<link rel="stylesheet" href="../../css/ui-color.css">
		<link rel="stylesheet" href="../../css/appcan.icon.css">
		<link rel="stylesheet" href="../../css/appcan.control.css">
		<link rel="stylesheet" type="text/css" href="../../css/main.css" />
		<link rel="stylesheet" type="text/css" href="css/plane.css" />
		<style type="text/css">
			#header{
			    font-size: 1em;
			}
			#header, #dateList, .plane-t-head{
				position: initial;
			}
			.longlist{overflow-y: scroll;-webkit-overflow-scrolling : touch;}
			.loading-box{
			    padding: 0.5rem 0.8rem;
			    font-size: 1.2rem;
			}
			.loading-pic{
			    width: 4rem;
			    height: 4rem;
			}
			[v-cloak]{display: none !important;}
		</style>
        <script type="text/javascript" src="../../js/setSkin.js"></script>
	</head>
	<body class="um-vp sc-bg-active ub" ontouchstart>
		<div class="ub-con ub ub-ver" id="planeBookList" v-cloak>
		    <div id="header" class="uh ub header-bg plane-list-header plane-book-head">
	            <div class="nav-btn back" id="nav-left">
	                <div class="ub-img user-icon-goback umw1-5 umh4"></div>
	            </div>
	            <div class="ub ub-ver ub-f1 title">
	                <div class="ub ub-ac ub-pc ub-f1 ulev-3 ut-s tx-c">
	                	<div id="isBack"></div>
	                    <div id="depPlane">北京</div>
	                    <div class="head-icon ub-img"></div>
	                    <div id="arrPlane">上海</div>
	                </div>
	                <p class="cur-day ub ub-pc" id="curDay"></p>
	            </div>
	            <div class="nav-btn nav-bt icon-act" id="nav-right">
	                <a class="ub-img user-icon-phone umw1-5 umh4 ub ub-ac" href="tel:02086132900"></a>
	            </div>
	        </div>
	        <div class="plane-t-head header-bg">
	            <div class="plane-t-info ub">
	                <div>
	                    <p class="big" id="fromTime">{{flight.myDepDate}}</p>
	                    <p id="fromName">{{flight.fromName}}</p>
	                </div>
	                <div class="ub ub-ac ub-ver">
	                    <div class="arrow ub-img" id="duration">{{parseInt(flight.duration/60)+ 'h' + parseInt(flight.duration % 60) + 'm'}}</div>
	                    <p id="stop" class="stop">{{flight.stopNum > 0 ? '经停' : ''}}</p>
	                </div>
	                <div>
	                    <p class="big" id="toTime">{{flight.myArrDate}}</p>
	                    <p id="toName">{{flight.toName}}</p>
	                </div>
	            </div>
	            <div class="plane-t-tails">
	                <img :src="flight.logo" class="logo-img" onerror="this.src='img/logo/logo.png'" id="logoImg" />
	                <span class="name" id="aircode">{{flight.companyName}} {{flight.carrier}}</span>
	                <span>|</span>
	                <span class="num" id="flightnum">{{flight.flightNo}}</span>
	                <span>|</span>
	                <span id="fool">{{flight.fool ? '有餐' : '无餐'}}</span>
	            </div>
	        </div>
		    <div class="ub-f1 longlist">
	            <ul class="plane-book-ul">
	                <li class="ub ub-ac" v-for='item in items'>
	                    <div class="ub-f1">
	                        <p class="pink">
	                            <span v-if="item.price==''">暂无价格</span>
	                            <span v-else>￥{{item.price}} <span class="small">{{flight.tax>0?'+ ￥'+flight.tax:''}} {{flight.yq>0?'+ ￥'+flight.yq:''}}</span></span>
	                        </p>
	                        <p class="cost" v-if="flight.tax > 0 || flight.yq>0">
	                            <span class="small">{{item.tax}} {{item.yq}}</span>
	                        </p>
	                        <p>
	                            <span>{{item.shipping}} {{item.myDiscount}}</span>
	                        </p>
	                    </div>
	                    <div v-if="item.price != ''">                       
	                        <div class="book" v-if="item.seatsRemain=='A'">
	                            <div class="b-btn ub ub-ac ub-pc" v-on:click="book(item)">预订</div>
	                        </div>
	                        <div class="book num" v-else v-on:click="book(item)">
	                            <div class="num-btn ub ub-ac ub-pc">预订</div>
	                            <div class="surplus ub ub-ac ub-pc">剩{{item.seatsRemain}}张</div>
	                        </div>
	                    </div>
	                </li>
	            </ul>
		    </div>
	    </div>
	</body>
	<script src="../../js/appcan.js"></script>
	<script src="../../js/appcan.control.js"></script>
	<script src="../../js/vue.min.js"></script>
	<script src="js/shipping.js"></script>
	<script src="../../js/common.js"></script>
	<script>
	    $(function(){
			if(appcan.locStorage.getVal("return") == "true") {
                if(appcan.locStorage.getVal("returnFlight")==0){
                    $("#isBack").html("往：");
                    $("#depPlane").html(appcan.locStorage.getVal("flightFromCity"));
                    $("#arrPlane").html(appcan.locStorage.getVal("flightToCity"));
                }
                else if(appcan.locStorage.getVal("returnFlight")==1){
                    $("#isBack").html("返：");
                    $("#depPlane").html(appcan.locStorage.getVal("flightToCity"));
                    $("#arrPlane").html(appcan.locStorage.getVal("flightFromCity"));
                }
            }
            else{
                $("#depPlane").html(appcan.locStorage.getVal("flightFromCity"));
                $("#arrPlane").html(appcan.locStorage.getVal("flightToCity"));
            }
	    	
			var getDay = appcan.locStorage.getVal("returnFlight")==0?appcan.locStorage.getVal("airDate"):appcan.locStorage.getVal("backAirDate");
			$("#curDay").text(NYR(getDay, 2) + ' ' + NYR(getDay, 3));
			
	        appcan.button("#nav-left", "btn-act", function() {
                appcan.locStorage.setVal("returnFlight",0);
                window.history.back();
            });
            appcan.button("#nav-right", "btn-act", function() {
                //uexCall.dial("02086132900");
            });
            $("#depPlane").html(appcan.locStorage.getVal("flightFromCity"));
            $("#arrPlane").html(appcan.locStorage.getVal("flightToCity"));
	    });
	    
	    var flightDetail;
	    if(appcan.locStorage.getVal("return")=="true" && appcan.locStorage.getVal("returnFlight")==1){
	        flightDetail = appcan.locStorage.getVal('backFlightDetail');
	    }
	    else{
	        flightDetail = appcan.locStorage.getVal("flightDetail");
	    }
		flightDetail = eval('(' + flightDetail + ')');
		if(flightDetail) {
			var seats = flightDetail.seats;
			for(var i = 0; i < seats.length; i++) {
				if(myShipping[seats[i].code]) {
					seats[i].shipping = myShipping[seats[i].code];
				} else {
					seats[i].shipping = '其他舱位';
				}
				var discount = (seats[i].sale * 1 / 10).toFixed(1);
				if(discount > 0 && discount < 10) {
					seats[i].myDiscount = discount + '折';
				} else {
					seats[i].myDiscount = '';
				}
				seats[i].tax = flightDetail.tax > 0 ? '机场建设费：￥' + flightDetail.tax : '';
				seats[i].yq = flightDetail.yq > 0 ? '燃油费：￥' + flightDetail.yq : '';
			}

			var app = new Vue({
				el: '#planeBookList',
				data: {
					items: seats,
					flight:flightDetail
				},
				methods: {
					book: function(item) {
                        if(item.seatsRemain<1){
                            return;
                        }
				        var beginDate = new Date(appcan.locStorage.getVal("begin")),
                            endDate = new Date(appcan.locStorage.getVal("end")),
                            airDate = new Date(appcan.locStorage.getVal("airDate")),
                            applyId = appcan.locStorage.getVal("itineraryId"),
                            backFlightDetail = null,
                            flightDetail = null;
                        
						if(appcan.locStorage.getVal("returnFlight")==0){
						    appcan.locStorage.setVal("seatDetail",item);
						    checkPrice(appcan.locStorage.getVal("flightDetail"),appcan.locStorage.getVal("seatDetail"),appcan.locStorage.getVal("airDate"));
						}
						else if(appcan.locStorage.getVal("return")=="true" && appcan.locStorage.getVal("returnFlight")==1){
                            backFlightDetail=JSON.parse(appcan.locStorage.getVal("backFlightDetail"));
                            flightDetail=JSON.parse(appcan.locStorage.getVal("flightDetail"));
                            if(backFlightDetail.depDate.time<flightDetail.arrDate.time){
                                alert("返程航班出发时间不能早于去程航班时间");
                                return;
                            }
						    appcan.locStorage.setVal("backSeatDetail",item);
						    checkPrice(appcan.locStorage.getVal("backFlightDetail"),appcan.locStorage.getVal("backSeatDetail"),appcan.locStorage.getVal("backAirDate"));
						}
						
					}
				}
			});
        }
		
		function checkPrice(fd,sd,airDate){
            var flightDetail = JSON.parse(fd),
                seatDetail = JSON.parse(sd);
            ajaxRequest({
                url:httpHost+"flightController.do?checkPriceWithoutPNRModular",
                data:{
                    "carrier":flightDetail.carrier,
                    "flightNo":flightDetail.flightNo,
                    "classCode":seatDetail.code,
                    "depart" :flightDetail.depart,
                    "arrival":flightDetail.arrival,
                    "departDate":airDate,
                    "F_price":Number(seatDetail.price),
                    "T_price":Number(flightDetail.tax)+Number(flightDetail.yq),
                    "A_price":Number(seatDetail.price)+Number(flightDetail.tax)+Number(flightDetail.yq),
                },
                dataType:"json",
                type:"POST",
                success:function(dataJson){
                   if(dataJson.obj !== null){
                       for(var i = 0;i<dataJson.obj.items.length;i++){
                           switch(dataJson.obj.items[i].type){
                               case "F":
                                  seatDetail.price = Number(dataJson.obj.items[i].value);
                                  break;
                               case "X":
                                  flightDetail.tax = Number(dataJson.obj.items[i].value);
                                  break;
                               default:
                                  break;
                           }
                        }
                        seatDetail.priceObj = dataJson.obj;
                        if(appcan.locStorage.getVal("returnFlight")==1 && appcan.locStorage.getVal("return")=="true"){
                            appcan.locStorage.setVal("backFlightDetail",flightDetail);
                            appcan.locStorage.setVal("backSeatDetail",seatDetail);
                            window.location.href = "plane_ticket_bookdetails_content.html";
                        }
                        else if(appcan.locStorage.getVal("return")=="true" && appcan.locStorage.getVal("returnFlight")==0){
                            appcan.locStorage.setVal("flightDetail",flightDetail);
                            appcan.locStorage.setVal("seatDetail",seatDetail);
                            appcan.locStorage.setVal("returnFlight",1);
                            window.location.href = "plane_ticket_searchresult_content.html";
                        }
                        else if(appcan.locStorage.getVal("return")==="false"){
                            appcan.locStorage.setVal("flightDetail",flightDetail);
                            appcan.locStorage.setVal('seatDetail', seatDetail);
                            window.location.href = "plane_ticket_bookdetails_content.html";
                        }
                        else{
                            alert("请退出重试");
                        }
                    }
                    else if(!dataJson.obj){
                   		alert("航班"+flightDetail.carrier+flightDetail.flightNo+"暂时无法预订，请选择其他航班");
                        window.history.back();
                   }
               },
               error:function(e,errMsg,error,err,ea){
                   console.log(e);
               }
            },"../../img/loading.gif");
        }
	</script>

</html>