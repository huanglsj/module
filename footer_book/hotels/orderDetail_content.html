<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">
    <head>
        <title></title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <link rel="stylesheet" href="../../css/fonts/font-awesome.min.css">
        <link rel="stylesheet" href="../../css/ui-box.css">
        <link rel="stylesheet" href="../../css/ui-base.css">
        <link rel="stylesheet" href="../../css/ui-color.css">
        <link rel="stylesheet" href="../../css/appcan.icon.css">
        <link rel="stylesheet" href="../../css/appcan.control.css">
        <link rel="stylesheet" href="../../css/main.css"/>
        <link rel="stylesheet" href="orderDetail/css/main.css" />
    </head>
    <style type="text/css">
        .bgset{
            font-size:16px !important;
            opacity:1;
            filter:Alpha(opacity=1);
        }
        .loading-box{
            padding:16px 32px;
        }
        .loading-pic{
            width:64px;
            height:64px;
        }
        .loading-text p{
            color:#3A5A98;
        }
    </style>
    <body class="um-vp user-bc-bg bg-white" style="font-size:16px;background-color:#f4f8f9" ontouchstart>
        <div id="header" class="uh bc-text-head ub header-bg">
                <div class="nav-btn back" id="nav-left">
                    <div class="ub-img user-icon-goback umw1-5 umh4"></div>
                </div>
                <h1 class="ut ub-f1 ulev-3 ut-s tx-c title-c" tabindex="0">酒店订单</h1>
                <div class="nav-btn nav-bt icon-act" id="nav-right">
                    <div class="ub-img  umw1-5 umh4 phone"></div>
                </div>
        </div>
        <!--订单信息-->
        <div class="order-detail section">
            <div style="width:7.694rem;">
                <div class="od-hotel">已预订酒店</div>
                <div id="orderId">
                    订单号：<span id="orderNumber"></span>
                </div>
            </div>
            <div style="width:3.006rem;">
                订单总价： ￥<span id="price"></span>
            </div>
        </div>
        
        <!-- 酒店信息  -->
        <div class="hotel-detail section">
            <div id="hotelName" class="hd-hotel"></div>
            <div id="roomType" class="message"></div>
            <div class="message hd-date">入住：<span id="beginDate"></span>-<span id="endDate"></span> 共<span id="duration"></span>晚</div>
            <div class="message">早餐：<span id="breakfast"></span></div>
        </div>
        
        <!-- 入住人信息  -->
        <div class="section guest-detail">
            <div class="gd-room">
                <span class="gd-room-title">房间数量</span><span class="gd-room-count"><span id="roomCount"></span>间</span>
            </div>
            <div class="gd-guestslist">
                <div style="min-width:2.6rem">
                    入住人
                </div>
                <div id="guests">
                    <div class="guest" v-for="guest in guests">
                        {{guest.name}}
                    </div>
                </div>
            </div>
            <div class="gd-phone">
                 <span class="gd-phone-title">
                                                             联系电话
                 </span>
                 <span class="gd-phone-number">
                     <input disabled="disabled" type="text" id="contactPhone" value="" />
                 </span>
                 <img src="orderDetail/img/phone_c.png" />
            </div>
        </div>
        <!-- footer  -->
        <div id="footer">
            <div class="footer-inside">
                <div id="confirmOrder" class="footer-submit">
                        确认付款
                </div>
            <div id="cancelOrder" class="footer-cancel">
                        取消订单
                </div>
            </div>
        </div>
        <script src="../../js/appcan.js"></script>
        <script src="../../js/appcan.control.js"></script>
        <script src="../../js/common.js"></script>
        <script src="../../js/vue.js"></script>
        <script>
            var orderId,totalPrice;
            function confirm(){
                ajaxRequest({
                    url:httpHost + 'hotelController.do?confirmHotelOrder',
                    beforeSend:addHeader,
                    type:'post',
                    data:{
                        orderId:orderId,
                        totalPrice:totalPrice
                        },
                    success:function(data){
                      removeMask();
                      objson = eval('('+data+')');
                      console.log(objson);
                      appcan.window.closeToast();
                      if(objson.success == true){
						  $('.od-hotel').html('已支付成功');
						  hideBtn();
                          //appcan.window.openToast(objson.msg,2000);
                      }
                      else{
                          if(objson.msg=="用户未登录"){
                          reLogin(confirm);
                        }else{
                          appcan.window.openToast(objson.msg, 2000);  
                        }
                      }
                    },
                    error:function(err,msg,error){
                      removeMask();
                      appcan.window.closeToast();
                      appcan.window.openToast("支付失败",2000);
                    }
                },"../../img/loading.gif");
            }
            function hideBtn(){
                $('#confirmOrder').hide();
            }
            function cancelOrder(){
                ajaxRequest({
                    url : httpHost+'hotelController.do?cancelOrder',
                    type : 'POST',
                    data :{orderId:orderId},
                    beforeSend:addHeader,
                    success : function(data) {
                        removeMask();
                        objson = eval('(' + data + ')');
                        appcan.window.closeToast();
                        if(objson.success){
                            //appcan.window.openToast('取消订单成功！', 1500, 5);
                            appcan.window.alert({
                                title:'提示',
                                content:'取消订单成功。请点击确定返回主页面',
                                buttons:'确定',
                                callback:function(err,data,dataType,optId){
                                  var pages = ["hotelOrderDetail","hotel_show","hotel_details","hotellist"];
                                  for(var i = 0;i<pages.length;i++){
                                    appcan.window.evaluateScript({
                                      name:pages[i],
                                      scriptContent:"appcan.window.close(-1)"
                                    });
                                  }
                                  setTimeout('appcan.window.close(-1)',500);
                                }
                            });
                        }else{
                            if(objson.msg=="用户未登录"){
                              reLogin(cancelOrder);
                            }else{
                              appcan.window.openToast(objson.msg, 2000);  
                            }
                        }
                    },
                    error:function(err,msg,error){
                      removeMask();
                      appcan.window.closeToast();
                      appcan.window.openToast("取消失败",2000);
                    }
                },"../../img/loading.gif")
            }
            appcan.ready(function() {
                $(".order-detail").offset({
                    top:$("#header").height(),
                })
                setFontSize();
                var hotelOrder = new Vue({
                    el:"#guests",
                    data:{
                        guests:[],
                    }
                });
                var hotelOrderMsg = appcan.locStorage.getVal("hotelOrderMsg");
                if(hotelOrderMsg == 'RES'){
                    $(".od-hotel").html("正在确认酒店房源");
                    hideBtn();
                }else if(hotelOrderMsg == 'RCM' || hotelOrderMsg == 'CON'){
                    $(".od-hotel").html("已成功预订");
                    hideBtn();
                }else if(hotelOrderMsg == 'RCM' || hotelOrderMsg == 'CON'){
                    $(".od-hotel").html("已成功预订");
                    hideBtn();
                }
                else if(hotelOrderMsg == 'SD'){
                    $(".od-hotel").html("订单支付失败，被作废");
                    hideBtn();
                }
                var hotelOrderDetail = appcan.locStorage.getVal("hotelOrderDetail");
                hotelOrderDetail = eval('(' + hotelOrderDetail + ')');
                console.log(hotelOrderDetail);
                orderId = hotelOrderDetail.resOrderID;
                var personAry = hotelOrderDetail.resGuests;
                var personName;
                for(var i=0;i<personAry.length;i++){
                    hotelOrder.guests.push({
                        "name" : personAry[i].guestProfile.personName,
                    })
                    /*
                    personName = personAry[i].guestProfile.personName;
                                        html +='<span class="personSpan">'+personName+'</span>&nbsp;';*/
                }
                totalPrice = hotelOrderDetail.totalAmount;
                var startDate = hotelOrderDetail.resGlobalInfo.timeSpan.startDate;
                var endDate = hotelOrderDetail.resGlobalInfo.timeSpan.endDate;
                var hotelName = appcan.locStorage.getVal("hotelName");
                var duration = (new Date(endDate) - new Date(startDate))/86400000;
                var contactPhone = hotelOrderDetail.contactorInfo.profile.mobile;
                var breakfast = hotelOrderDetail.roomStays[0].roomRates[0].ratePlanName;
                var roomType = hotelOrderDetail.roomStays[0].roomRates[0].roomTypeName;
                var roomCount = hotelOrderDetail.resGuests.length;
                // var hotelTel = appcan.locStorage.getVal("hotelTel");
                // var hotelAddr = appcan.locStorage.getVal("hotelAddr");
                $("#price").html(totalPrice);
                $("#orderId").html("订单号："+orderId);
                $("#beginDate").html(startDate);
                $("#endDate").html(endDate);
                $("#hotelName").html(hotelName);
                $("#duration").html(duration);
                $("#contactPhone").val(contactPhone);
                $("#breakfast").html(breakfast);
                $("#roomType").html(roomType);
                $("#roomCount").html(roomCount);
                // $("#hotelTel").html(hotelTel);
                // $("#hotelAddr").html(hotelAddr);
                
                appcan.button("#nav-left", "btn-act", function() {
                    var pages = ["hotelOrderDetail","hotel_show","hotel_details","hotellist","hotelOrderDetail"];
                    for(var i = 0;i<pages.length;i++){
                        appcan.window.evaluateScript({
                            name:pages[i],
                            scriptContent:"appcan.window.close(1)"
                        });
                    }
                });
                appcan.button("#nav-right", "btn-act", function() {
                    uexCall.dial("02086132900");
                });
                
                appcan.button("#confirmOrder","btn-act",function(){
                    checkSubmit(confirm);
                });
                appcan.button("#cancelOrder","btn-act",function(){
                    checkSubmit(cancelOrder);
                })
            });
        </script>
    </body>
</html> 
