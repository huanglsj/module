<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">
    <head>
        <title></title>
        <meta charset="utf-8">
        <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <link rel="stylesheet" href="../../css/fonts/font-awesome.min.css">
        <link rel="stylesheet" href="../../css/ui-box.css">
        <link rel="stylesheet" href="../../css/ui-base.css">
        <link rel="stylesheet" href="../../css/ui-color.css">
        <link rel="stylesheet" href="../../css/appcan.icon.css">
        <link rel="stylesheet" href="../../css/appcan.control.css">
        <link rel="stylesheet" type="text/css" href="../../css/main.css"/>
        <link rel="stylesheet" href="css/hotel_city.css">
    </head>
    <style>
      .result{
        padding:.3rem;
        border-bottom: 1px solid;
      }
    </style>
    <body class="um-vp bc-bg" ontouchstart>
        <div id="header" class="uh bc-text-head ub header-bg">
                <div class="nav-btn" id="nav-left">
                    <div class="ub-img user-icon-goback umw1-5 umh4"></div>
                </div>
                <div class="ut ub-f1 ulev-3 ut-s tx-c" id="nav-center">
                   <div class="city-bg uinput ub ub-f1 uba uc-a1 ub-ac" style="background-color: #ffffff">
                        <div class="uinn fa fa-search sc-text padding0"></div>
                        <input autocomplete="autocomplete" style="background-color: transparent" placeholder="北京/beijing/bj/bjs/中国" type="text" class="ub-f1 search">
                    </div>
                </div>
        </div>
        <div style="width: 100%;height: 100%;background-color:#EEE;filter: alpha(opacity=50);opacity: 0.5;position: fixed;z-index: 100;top: 0; display:none" id="barrier"></div>
        <div class="umar-a" id="cityarea">
            <div class="uinn ubb bc-border" id="history">
                <div class="ulev-app2">
                    当前/历史
                </div>
                <div class="city uba bc-border ub-f1 uinn-d umar-2 ub ub-ac ub-pc min-w5 ulev-1" id="currentCity">
                </div>
            </div>
            <div class="uinn ubb bc-border" id="hotCity"></div>
        </div>
        <div id="list"></div>
    </body>
    <script src="../../js/appcan.js"></script>
    <script src="../../js/appcan.control.js"></script>
    <script src="../../js/common.js"></script>
    </body>
    <script>
        var cityArr=[];
        cityArr["type"] = "hotel";
        var data,cityNum,count=0,str=[],i,j,str1='',
        hotCity='<div class="ulev-app2">热门</div>',
        hotCityArr = [{
            "cityCode":"PEK",
            "cityName":"北京",
          },{
            "cityCode":"SHA",
            "cityName":"上海",
          },{
            "cityCode":"CAN",
            "cityName":"广州",
          },{
            "cityCode":"SZX",
            "cityName":"深圳",
          },{
            "cityCode":"HKG",
            "cityName":"香港",
          },{
            "cityCode":"MFM",
            "cityName":"澳门",
          },{
            "cityCode":"CTU",
            "cityName":"成都",
          },{
            "cityCode":"CKG",
            "cityName":"重庆",
          },{
            "cityCode":"TSN",
            "cityName":"天津",
          },{
            "cityCode":"CSX",
            "cityName":"长沙",
          },{
            "cityCode":"DLC",
            "cityName":"大连",
          },{
            "cityCode":"SIA",
            "cityName":"西安",
          },{
            "cityCode":"TAO",
            "cityName":"青岛",
          },{
            "cityCode":"XMN",
            "cityName":"厦门",
          },{
            "cityCode":"HGH",
            "cityName":"杭州",
          },{
            "cityCode":"NKG",
            "cityName":"南京"
        }];
        appcan.ready(function() {
            $("#barrier,#cityarea,#list").offset({
                top:$("#header").height(),
            })
            appcan.button(".nav-btn", "btn-act", function() {
                appcan.window.evaluateScript({
                    name:"hotelCity",
                    scriptContent:"appcan.window.close(1)"
                })
            })
            $(".search").bind("input propertychange",function(){
                var text = $(this).val();
                if((65<=text.charCodeAt(0) && text.charCodeAt(0)<=90 )||(97<=text.charCodeAt(0) && text.charCodeAt(0)<=122)){
                    pinyinSearch(text);
                    bindButton();
                }
                else{
                    othersSearch(text);
                    bindButton();
                }
            })
            $(".search").focus(function(){
                var text = $(this).val();
                pinyinSearch(text);
                $("#barrier").show();
            })
            $(".search").blur(function(){
                //$("#barrier").hide();
                setTimeout("$('#barrier').hide()",100);
            })
            //openDataBase();
            //createTable("hotel");
            //getData("hotel");
            addMask('../../img/loading.gif','数据加载中，请稍后');
            if(isDefine(appcan.locStorage.getVal("hotelCityArr"))){ 

                //城市更新标志
                hotelCityArr = eval('(' + appcan.locStorage.getVal("hotelCityArr") + ')');
                console.log(hotelCityArr);
                if(new Date() - new Date(hotelCityArr.updDate) > 2592000000){
                  queryHotelCity();
                }
                else{
                  data = hotelCityArr.data;
                  cityArr["data"] = data.obj;
                  getHistoryCity();
                  bindCityCode();
                  cityNum = data.obj.length;
                  for(i = 0;i<26;i++){
                    str[i]='<div id="'+String.fromCharCode((65+i))+'" class="uinn sc-bg-active ubb bc-border bc-  text">'+String.fromCharCode((65+i))+'</div>';
                  }
                  for(count=0;count<cityNum;count++){
                    for(j=0;j<26;j++){
                      if(data.obj[count].cityPinYin.charAt(0).toUpperCase() == String.fromCharCode((65+j))){
                        str[j]+='<div class="city ulev-1 uinn bc-bg b-gra" data-cityPinYin="'+data.obj[count].  cityPinYin+'" data-city="'+data.obj[count].cityCode+'">'+data.obj[count].cityName+'</div>'  ;
                        break;
                      }
                    }
                  }
                  for(i=0;i<26;i++){
                    if(str[i]!='<div id="'+String.fromCharCode((65+i))+'" class="uinn sc-bg-active ubb bc-border bc-  text">'+String.fromCharCode((65+i))+'</div>'){
                      str1+=str[i];
                    }
                  }
                  for(count=0;count<hotCityArr.length;count++){
                    if(count%4==0){
                      hotCity+="<div class='ub umar-a'><div class='city uba bc-border ub-f1 uinn-d umar-2 ub ub-  ac ub-pc min-w5 ulev-1' data-city="+hotCityArr[count].cityCode+">"+hotCityArr[count].cityName+  "</div>";
                    }
                    else if(count%4==3){
                      hotCity+="<div class='city uba bc-border ub-f1 uinn-d umar-2 ub ub-ac ub-pc min-w5 ulev-1'  data-city="+hotCityArr[count].cityCode+">"+hotCityArr[count].cityName+"</div></div>";
                    }
                    else{
                      hotCity+="<div class='city uba bc-border ub-f1 uinn-d umar-2 ub ub-ac ub-pc min-w5 ulev-1'  data-city="+hotCityArr[count].cityCode+">"+hotCityArr[count].cityName+"</div>";
                    }
                  }
                  $("#list").html(str1);
                  $("#hotCity").html(hotCity);
                  removeMask();
                  bindButton();
                }
            }
            else{
              queryHotelCity();
          }  
        });

        function queryHotelCity(){
            appcan.request.ajax({
              url:httpHost + "hotelController.do?queryCity",
              beforeSend:addHeader,
              type:'post',
              success:function(data){
                dataJson = eval('(' + data + ')');
                if(dataJson.success){
                  var hotelCityArr = {
                    "data":dataJson,
                    "updDate":new Date(),
                  }
                  appcan.locStorage.setVal("hotelCityArr",hotelCityArr);
                  cityArr["data"] = dataJson.obj;
                  getHistoryCity();
                  bindCityCode();
                  cityNum = dataJson.obj.length;
                  for(i = 0;i<26;i++){
                  str[i]='<div id="'+String.fromCharCode((65+i))+'" class="uinn sc-bg-active ubb bc-border bc-text">'+String.fromCharCode((65+i))+'</div>';
                  }
                  for(count=0;count<cityNum;count++){
                    for(j=0;j<26;j++){
                      if(dataJson.obj[count].cityPinYin.charAt(0).toUpperCase() == String.fromCharCode((65+j))){
                        str[j]+='<div class="city ulev-1 uinn bc-bg b-gra" data-cityPinYin="'+dataJson.obj[count].cityPinYin+'" data-city="'+dataJson.obj[count].cityCode+'">'+dataJson.obj[count].cityName+'</div>';
                        break;
                      }
                    }
                  }
                  for(i=0;i<26;i++){
                    if(str[i]!='<div id="'+String.fromCharCode((65+i))+'" class="uinn sc-bg-active ubb bc-border bc-  text">'+String.fromCharCode((65+i))+'</div>'){
                      str1+=str[i];
                    }
                  }
                  for(count=0;count<hotCityArr.length;count++){
                    if(count%4==0){
                      hotCity+="<div class='ub umar-a'><div class='city uba bc-border ub-f1 uinn-d umar-2 ub ub-ac ub-pc min-w5 ulev-1' data-city="+hotCityArr[count].cityCode+">"+hotCityArr[count]. cityName+  "</div>";
                    }
                    else if(count%4==3){
                      hotCity+="<div class='city uba bc-border ub-f1 uinn-d umar-2 ub ub-ac ub-pc min-w5 ulev-1' data-city="+hotCityArr[count].cityCode+">"+hotCityArr[count].cityName+"</div></div>";
                    }
                    else{
                      hotCity+="<div class='city uba bc-border ub-f1 uinn-d umar-2 ub ub-ac ub-pc min-w5 ulev-1' data-city="+hotCityArr[count].cityCode+">"+hotCityArr[count].cityName+"</div>";
                    }
                  }
                  $("#list").html(str1);
                  $("#hotCity").html(hotCity);
                  removeMask();
                  bindButton();
                }else{
                    if(dataJson.msg=="用户未登录"){
                      reLogin(queryHotelCity);
                    }else{
                      appcan.window.openToast(dataJson.msg, 2000);  
                    }
                }
              },
              error:function(){
                appcan.window.openToast("获取数据失败",3000);
                removeMask();
              }
            })
        }
        function bindButton(){
          $(".city").unbind("click");
          appcan.button(".city","btn-act",function(){
            var city =$(this).text().trim();
            var cityNode=$(this).attr("data-city").trim();
            var historyCity = appcan.locStorage.getVal(cityArr["type"]+"historyCity");
            historyCity = eval('(' + historyCity + ')');
            if(historyCity.length<5){
              for(var i =0;i<historyCity.length;i++){
                if(city == historyCity[i].city){
                  historyCity.splice(i,1);
                  historyCity.unshift({
                    city:city,
                    cityCode:cityNode
                  });
                  i--;
                  break;
                }
              }
              if(i === historyCity.length){
                historyCity.unshift({
                  city:city,
                  cityCode:cityNode
                });
              }
            }
            else if (historyCity.length === 5){
              for(var i =0;i<historyCity.length;i++){
                if(city == historyCity[i].city){
                  historyCity.splice(i,1);
                  historyCity.unshift({
                    city:city,
                    cityCode:cityNode
                  });
                i--;
                break;
                }
              }
              if(i === historyCity.length){
                historyCity.pop();
                historyCity.unshift({
                  city:city,
                  cityCode:cityNode
                });
              }
            }
            else if (historyCity.length > 5){
              historyCity.splice(0,historyCity.length,{
                city:city,
                cityCode:cityNode
              });
            }
            if(city != appcan.locStorage.getVal("currentCity")){
              appcan.locStorage.setVal(cityArr["type"]+"historyCity",historyCity);
            }
            if(appcan.locStorage.getVal("fromcity")=="true"){
              appcan.frame.evaluateScript({
                  name:"hotelsearch",
                  popName:"content",
                  scriptContent:"setHotelCity('"+city+","+cityNode+"')"
              });
              appcan.window.evaluateScript({
                name:'hotelCity',
                scriptContent:'appcan.window.close(-1)'
              });
            }
          });
        }

        var pinyinSearch = function(text){
          if(text===''){
            $("#barrier").html('');
            return;
          }
          text = text.toUpperCase();
          var textLength = text.length;
          var elements = $(".city[data-cityPinYin]");
          var elementsLength = elements.length;
          var counti=0,countj=0,cursor=-1,flag=true,result=[],i=0,str='';

          for(;counti<elementsLength;counti++){
            if(elements[counti].getAttribute("data-cityPinYin").toUpperCase().indexOf(text)==0){
              result.push({
                cityCode:$(".city[data-cityPinYin]")[counti].getAttribute("data-city"),
                cityName:$(".city[data-cityPinYin]")[counti].innerHTML
              })
            }
          }
          if(result.length == 0){
            counti=0;
          }
          else{
            for(;i<result.length;i++){
              str+='<div class="city result" data-city="'+result[i].cityCode+'">'+result[i].cityName+'</div>';
            }
            $("#barrier").html(str);
            $("#barrier").css("opacity",1);
            return;
          }

          for(;counti<elementsLength;counti++){
            if(elements[counti].getAttribute("data-cityPinYin").toUpperCase() == text.toUpperCase()){
              result.push({
                cityCode:elements[counti].getAttribute("data-city"),
                cityName:elements[counti].innerHTML
              });
              break;
            }
            else{
              for(;countj<textLength;countj++){
                if(elements[counti].getAttribute("data-cityPinYin").toUpperCase().indexOf(text.charAt(countj).toUpperCase()) > cursor){
                  cursor = elements[counti].getAttribute("data-cityPinYin").toUpperCase().indexOf(text.charAt(countj).toUpperCase());
                }
                else{
                  flag=false;
                  break;
                }
              }
              cursor = -1;
              countj = 0;
              if(flag === true){
                result.push({
                  cityCode:elements[counti].getAttribute("data-city"),
                  cityName:elements[counti].innerHTML
                });
              }
              flag=true;
            }
          }
          for(i = 0;i<result.length;i++){
            str+='<div class="city result" data-city="'+result[i].cityCode+'">'+result[i].cityName+'</div>';
          }
          $("#barrier").html(str);
          $("#barrier").css("opacity",1);
        }

        var othersSearch = function(text){
          if(text == ''){
            $("#barrier").html('');
            return;
          }
          var counti=0,str='';
          var textLength = text.length;
          var elements = $(".city[data-cityPinYin]");
          var elementsLength = elements.length;
          for(;counti<elementsLength;counti++){
            if(elements[counti].innerHTML.indexOf(text) > -1 ){
              str+='<div class="city result" data-city="'+elements[counti].getAttribute("data-city")+'">'+elements[counti].innerHTML+'</div>';
            }
          }
          $("#barrier").html(str);
          $("#barrier").css('opacity',1);
          return;
        }

    </script>
</html>
