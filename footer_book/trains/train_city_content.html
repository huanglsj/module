<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">
    <head>
        <title></title>
        <meta charset="utf-8">
        <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <link rel="stylesheet" href="../../css/fonts/font-awesome.min.css">
        <link rel="stylesheet" href="../../css/ui-box.css">
        <link rel="stylesheet" href="../../css/ui-base.css">
        <link rel="stylesheet" href="../../css/ui-color.css">
        <link rel="stylesheet" href="../../css/appcan.icon.css">
        <link rel="stylesheet" href="../../css/appcan.control.css">
        <link rel="stylesheet" href="train_city_content/css/main.css">
    </head>
    <style>
        .result{
          padding:.3rem;
          border-bottom: 1px solid;
        }
    </style>
    <body class="um-vp bc-bg" ontouchstart>
      <div style="width: 100%;height: 100%;background-color:#EEE;filter: alpha(opacity=50);opacity: 0.5;position: fixed;z-index: 100;top: 0; display:none" id="barrier"></div>
         <div class="umar-a" id="cityarea">
            <div class="uinn ubb bc-border" id="history">
                
            </div>
            <div id="favoriteStaion" class="uinn ubb bc-border">
                
            </div>
        </div>
        <div id="trainList"></div>
    </body>
    <script src="../../js/appcan.js"></script>
    <script src="../../js/appcan.control.js"></script>
    <script src="../../js/appcan.listview.js"></script>
    <script src="../../js/common.js"></script>
    <script>
    var from_City =false;
    var to_City = false;
    var stationData = {},cityArr=[];
    cityArr["type"] = "train"; 
     var data,cityNum,count=0,str=[],i,j,str1='',
     favoriteStaion='<div class="ulev-app2">热门</div>';
     appcan.ready(function(){
         addMask('../../img/loading.gif','数据加载中，请稍后');
         getHistoryCity();
         if(isDefine(appcan.locStorage.getVal("favoriteTrainStaion"))){ 

            //获取上次更新时间，判断是否需要更新
            var favoriteTrainStaion = eval('('+appcan.locStorage.getVal("favoriteTrainStaion")+')');
            var updDate = favoriteTrainStaion.updDate;
            if(new Date - new Date(updDate) > 2592000000){
              queryTrainFavorite();
            }
            else{
              data = favoriteTrainStaion.data;
              cityNum = data.length;
              for(count=0;count<cityNum;count++){
                  if(count%4==0){
                    favoriteStaion+="<div class='ub umar-a'><div class='city uba bc-border ub-f1 uinn-d umar-2 ub ub-ac ub-pc min-w5 ulev-1' data-city="+data[count].telecode+">"+data[count].name+"</div>";
                  }
                  else if(count%4==3){
                    favoriteStaion+="<div class='city uba bc-border ub-f1 uinn-d umar-2 ub ub-ac ub-pc min-w5 ulev-1' data-city="+data[count].telecode+">"+data[count].name+"</div></div>";
                  }
                  else{
                    favoriteStaion+="<div class='city uba bc-border ub-f1 uinn-d umar-2 ub ub-ac ub-pc min-w5 ulev-1' data-city="+data[count].telecode+">"+data[count].name+"</div>";
                  }
                  for(j=0;j<26;j++){
                    if(data[count].id.charAt(0).toUpperCase() == String.fromCharCode((65+j))){
                      str[j]+='<div class="city ulev-1 uinn bc-bg b-gra" data-city="'+data[count].telecode+'">'+data[count].name+'</div>';
                      break;
                    }
                  }
              }
              $("#favoriteStaion").html(favoriteStaion);
            }
         }
         else{
          queryTrainFavorite();
         }
         if(isDefine(appcan.locStorage.getVal("trainStation"))){
            var trainStation = eval('('+appcan.locStorage.getVal("trainStation")+')');
            if(new Date - new Date(trainStation.updDate) > 2592000000){
              queryTrainStation();
            }
            else{
              data = trainStation.data;
              cityArr["data"]=data;
              cityNum = data.length;
              bindCityCode();
              for(i = 0;i<26;i++){
                  str[i]='<div id="'+String.fromCharCode((65+i))+'" class="uinn sc-bg-active ubb bc-border bc-text">'+String.fromCharCode((65+i))+'</div>';
                  }
                  for(count=0;count<cityNum;count++){
                    for(j=0;j<26;j++){
                      if(data[count].pinyin.charAt(0).toUpperCase() == String.fromCharCode((65+j))){
                        str[j]+='<div class="city ulev-1 uinn bc-bg b-gra" data-pinyinName="'+data[count].pinyin+'" data-city="'+data[count].telecode+'">'+data[count].name+'</div>';
                        break;
                      }
                    }
                  }
                  for(i=0;i<26;i++){
                    if(str[i]!='<div id="'+String.fromCharCode((65+i))+'" class="uinn sc-bg-active ubb bc-border bc-text">'+String.fromCharCode((65+i))+'</div>'){
                      str1+=str[i];
                    }
              }
              $("#trainList").html(str1);
              removeMask();
              bindButton();
            }
         }
         else{
          queryTrainStation();
         }
    });
    function queryTrainFavorite(){
        appcan.request.ajax({
          url:httpHost + "trainController.do?queryFavorite",
          beforeSend:addHeader,
          type:'post',
          success:function(dataJson){
            var data = eval('('+dataJson+')');
            console.log(data);
            if(data.success){
                data=data.obj;
                var favoriteTrainStation = {
                    "data":data,
                    "updDate":new Date()
                }
                appcan.locStorage.setVal("favoriteTrainStaion",favoriteTrainStation);
              cityNum = data.length;
              for(count=0;count<cityNum;count++){
                  if(count%4==0){
                    favoriteStaion+="<div class='ub umar-a'><div class='city uba bc-border ub-f1 uinn-d umar-2 ub ub-ac ub-pc min-w5 ulev-1' data-city="+data[count].telecode+">"+data[count].name+"</div>";
                  }
                  else if(count%4==3){
                    favoriteStaion+="<div class='city uba bc-border ub-f1 uinn-d umar-2 ub ub-ac ub-pc min-w5 ulev-1' data-city="+data[count].telecode+">"+data[count].name+"</div></div>";
                  }
                  else{
                    favoriteStaion+="<div class='city uba bc-border ub-f1 uinn-d umar-2 ub ub-ac ub-pc min-w5 ulev-1' data-city="+data[count].telecode+">"+data[count].name+"</div>";
                  }
                for(j=0;j<26;j++){
                  if(data[count].id.charAt(0).toUpperCase() == String.fromCharCode((65+j))){
                    str[j]+='<div class="city ulev-1 uinn bc-bg b-gra" data-city="'+data[count].telecode+'">'+data[count].name+'</div>';
                    break;
                  }
                }
              }
            $("#favoriteStaion").html(favoriteStaion);
          }else{
            if(data.msg=="用户未登录"){
              reLogin(queryTrainFavorite);
            }else{
                appcan.window.openToast(data.msg, 2000);
            }
          }
        },
        error:function(e, err) {
            removeMask();
            appcan.window.openToast("数据加载失败，请返回重试",3000);
        }
      })
    }
    function queryTrainStation(){
        appcan.request.ajax({
          url:httpHost + "trainController.do?queryStation",
          beforeSend:addHeader,
          type:'post',
          success:function(dataJson){
            data = eval("("+dataJson+")");
            cityArr["data"]=data;
            bindCityCode();
            getHistoryCity();
            bindCityCode();
            if(data.success){
              data = data.obj;
              var trainStation = {
                "data":data,
                "updDate":new Date(),
              }
              appcan.locStorage.setVal("trainStation",trainStation);
              var cityNum = data.length,
              count=0,
              str=[],i,j,str1='';
              for(i = 0;i<26;i++){
              str[i]='<div id="'+String.fromCharCode((65+i))+'" class="uinn sc-bg-active ubb bc-border bc-text">'+String.fromCharCode((65+i))+'</div>';
              }
              for(;count<cityNum;count++){
                for(j=0;j<26;j++){
                  if(data[count].pinyin.charAt(0).toUpperCase() == String.fromCharCode((65+j))){
                    str[j]+='<div class="city ulev-1 uinn bc-bg b-gra" data-pinyinName="'+data[count].pinyin+'" data-city="'+data[count].telecode+'">'+data[count].name+'</div>';
                    break;
                  }
                }
              }
              for(i=0;i<26;i++){
                if(str[i]!='<div id="'+String.fromCharCode((65+i))+'" class="uinn sc-bg-active ubb bc-border bc-text">'+String.fromCharCode((65+i))+'</div>'){
                  str1+=str[i];
                }
              }
            $("#trainList").html(str1);
            removeMask();
            bindButton();
          }else{
            if(data.msg=="用户未登录"){
              reLogin(queryTrainStation);
            }else{
                appcan.window.openToast(data.msg, 2000);
            }
          }
        },
        error:function(e, err) {
            removeMask();
            appcan.window.openToast("数据加载失败，请返回重试",3000);
        }
      })
    }
        function bindButton(){
          $(".city").unbind("click");
          appcan.button(".city","btn-act",function(){
                  var city =$(this).text().trim();
                  var cityNode=$(this).attr("data-city").trim();
                  if(appcan.locStorage.getVal("from_city")=="true"){
                    appcan.window.evaluateScript({
                      name:'train_ticket_search',
                      popName:'content',
                      scriptContent:'setSingleFrom("'+city+','+cityNode+'")'
                    });
                  }
                  else if(appcan.locStorage.getVal("to_city")=="true"){
                    appcan.window.evaluateScript({
                      name:'train_ticket_search',
                      popName:'content',
                      scriptContent:'setSingleTO("'+city+','+cityNode+'")'
                    })
                  }
                  var historyCity = appcan.locStorage.getVal(cityArr["type"]+"historyCity");
                  historyCity = eval(historyCity);
                  if(historyCity.length<5){
                    for(var i =0;i<historyCity.length;i++){
                      if(city == historyCity[i].city){
                        historyCity.splice(i,1);
                        historyCity.unshift({
                          city:city,
                          cityCode:cityNode
                        });
                        i--;
                        break;
                      }
                    }
                    if(i === historyCity.length){
                      historyCity.unshift({
                        city:city,
                        cityCode:cityNode
                      });
                    }
                    
                  }
                  else if (historyCity.length === 5){
                    for(var i =0;i<historyCity.length;i++){
                      if(city == historyCity[i].city){
                        historyCity.splice(i,1);
                        historyCity.unshift({
                          city:city,
                          cityCode:cityNode
                        });
                        i--;
                        break;
                      }
                    }
                    if(i === historyCity.length){
                      historyCity.pop();
                      historyCity.unshift({
                        city:city,
                        cityCode:cityNode
                      });
                    }
                  }
                  else if (historyCity.length > 5){
                    historyCity.splice(0,historyCity.length,{
                      city:city,
                      cityCode:cityNode
                    });
                  }
                  if(city != appcan.locStorage.getVal("currentCity")){
                    appcan.locStorage.setVal(cityArr["type"]+"historyCity",historyCity);
                  }
                  appcan.window.evaluateScript({
                    name:'train_city',
                    scriptContent:'appcan.window.close(-1)'
                  });
                  appcan.window.evaluateScript({
                    name:'train_city',
                    scriptContent:'appcan.window.close(-1)'
                  })
          });
        }

        var pinyinSearch = function(text){
          if(text===''){
            $("#barrier").html('');
            return;
          }
          text = text.toUpperCase();
          var textLength = text.length;
          var elements = $(".city[data-pinyinName]");
          var elementsLength = elements.length;
          var counti=0,countj=0,cursor=-1,flag=true,result=[],i=0,str='';

          for(;counti<elementsLength;counti++){
            if(elements[counti].getAttribute("data-pinyinName").toUpperCase().indexOf(text)==0){
              result.push({
                cityCode:$(".city[data-pinyinName]")[counti].getAttribute("data-city"),
                cityName:$(".city[data-pinyinName]")[counti].innerHTML
              })
            }
          }
          if(result.length == 0){
            counti=0;
          }
          else{
            for(;i<result.length;i++){
              str+='<div class="city result" data-city="'+result[i].cityCode+'">'+result[i].cityName+'</div>';
            }
            $("#barrier").html(str);
            $("#barrier").css("opacity",1);
            return;
          }

          for(;counti<elementsLength;counti++){
            if(elements[counti].getAttribute("data-pinyinName").toUpperCase() == text.toUpperCase()){
              result.push({
                cityCode:elements[counti].getAttribute("data-city"),
                cityName:elements[counti].innerHTML
              });
              break;
            }
            else{
              for(;countj<textLength;countj++){
                if(elements[counti].getAttribute("data-pinyinName").toUpperCase().indexOf(text.charAt(countj).toUpperCase()) > cursor){
                  cursor = elements[counti].getAttribute("data-pinyinName").toUpperCase().indexOf(text.charAt(countj).toUpperCase());
                }
                else{
                  flag=false;
                  break;
                }
              }
              cursor = -1;
              countj = 0;
              if(flag === true){
                result.push({
                  cityCode:elements[counti].getAttribute("data-city"),
                  cityName:elements[counti].innerHTML
                });
              }
              flag=true;
            }
          }
          for(i = 0;i<result.length;i++){
            str+='<div class="city result" data-city="'+result[i].cityCode+'">'+result[i].cityName+'</div>';
          }
          $("#barrier").html(str);
          $("#barrier").css("opacity",1);
        }

        var othersSearch = function(text){
          if(text == ''){
            $("#barrier").html('');
            return;
          }
          var counti=0,str='';
          var textLength = text.length;
          var elements = $(".city[data-pinyinName]");
          var elementsLength = elements.length;
          for(;counti<elementsLength;counti++){
            if(elements[counti].innerHTML.indexOf(text) > -1 ){
              str+='<div class="city result" data-city="'+elements[counti].getAttribute("data-city")+'">'+elements[counti].innerHTML+'</div>';
            }
          }
          $("#barrier").html(str);
          $("#barrier").css("opacity",1);
        }
    </script>
</html>
