<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">

	<head>
		<title></title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link rel="stylesheet" href="../../css/fonts/font-awesome.min.css">
		<link rel="stylesheet" href="../../css/ui-box.css">
		<link rel="stylesheet" href="../../css/ui-base.css">
		<link rel="stylesheet" href="../../css/ui-color.css">
		<link rel="stylesheet" href="../../css/appcan.icon.css">
		<link rel="stylesheet" href="../../css/appcan.control.css">
		<link rel="stylesheet" href="../../css/main.css" />
		<link rel="stylesheet" href="../../css/mobiscroll.min.css">
		<link rel="stylesheet" href="../../css/mymedia.css">
		<link rel="stylesheet" href="css/train-ticket.css">

	</head>

	<body class="um-vp" ontouchstart>
		<div class="up ub ub-ver train-ticket-body" tabindex="0">
			<!--content开始-->
			<div id="content" class="ub-f1 tx-l">
				<div class="train-ticket-con">
					<div class="list first-head ub ub-ac">
						<div class="ub ub-f1 ub-ac">
							<ul class="select-ul" id="selectUl">
								<li data-val="无" data-id="0" data-begin="0" data-end="0">无</li>
							</ul>
							<div id="myText" class="text" style="display: none"></div>
						</div>
						<i class="fa fa-angle-right"></i>
					</div>
					<div class="list three-list">
						<div class="tr ub">
							<div class="address ub ub-ver ub-f1" id="openFromCity">
								<div class="name">始发地</div>
								<div class="con" id="from_city">广州</div>
							</div>
							<div class="icon"></div>
							<div class="address ub ub-ver ub-f1 ub-ae" id="openToCity">
								<div class="name">目的地</div>
								<div class="con" id="to_city">北京</div>
							</div>
						</div>
						<div class="tr" id="dateResult">
							<div class="name">出发日期</div>
							<div class="con">
								<span class="date"></span>
								<span class="week tx_red"></span>
								<input type="hidden" id="train_date" />
							</div>
						</div>
						<div class="tr ub ub-ac">
							<div class="ub ub-f1">只选高铁</div>
							<div id="highRail" class="switch uba bc-border switch-mini" data-checked="false">
								<div class="switch-btn sc-bg-active "></div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div id="submitBtn" class="m-footer">
                <div class="train-ticket-footer ub ub-pc ub-ac">
                    <img src="img/train_search.png" class="ub ub-ac">
                    <span class="ub ub-ac">查询</span>
                </div>
            </div>
			<!--content结束-->
		</div>
	</body>
	<script src="../../js/jquery.min.js"></script>
	<script src="../../js/appcan.js"></script>
	<script src="../../js/appcan.control.js"></script>
	<script src="../../js/mobiscroll.min.zh.js"></script>
	<script src="../../js/common.js"></script>
	<script src="train_city_content/js/trainStations.js"></script>
	<script>
		var dancheng = true;
		var wangfan = false;
		var dateMobiscroll,
			selectMobiscroll,
			mySelect = {
				id: 0
			};
		appcan.ready(function() {
			appcan.locStorage.setVal("historyCity", "[]");

			appcan.window.subscribe('closeTrainBookWin', function(msg) {
				appcan.window.close(-1);
			});

			if(appcan.locStorage.getVal("from_station_city")) {
				$("#from_city").html(appcan.locStorage.getVal("from_station_city"));
			} else {
				$("#from_city").html("广州");
				appcan.locStorage.setVal("from_station_city", "广州");
				appcan.locStorage.setVal("from_station", "GZQ");
			}
			if(appcan.locStorage.getVal("to_station_city")) {
				$("#to_city").html(appcan.locStorage.getVal("to_station_city"));
			} else {
				$("#to_city").html("北京");
				appcan.locStorage.setVal("to_station_city", "北京");
				appcan.locStorage.setVal("to_station", "BJP");
			}
			var isDongche = $('#highRail').attr("data-checked");
			appcan.locStorage.setVal("isDongche", isDongche);
			appcan.window.subscribe('singlefrom', function(msg) {
				setFromCity(msg);
			});
			appcan.window.subscribe('singleTo', function(msg) {
				setToCity(msg);
			});
			$('#openFromCity').click(function() {
				appcan.locStorage.setVal('from_city', 'true');
				appcan.window.open("train_city", '../trains/train_city.html', 2);
			})
			$('#openToCity').click(function() {
				appcan.locStorage.setVal("to_city", "true");
				appcan.window.open("train_city", '../trains/train_city.html', 2);
			});
			appcan.switchBtn("#highRail", function(obj, value) {
				var isDongche = $('#highRail').attr("data-checked");
				appcan.locStorage.setVal("isDongche", isDongche);
			});
			
			appcan.button("#submitBtn", "btn-act", searchTrain);
			init();
			getApply();
		})

		function init() {
			var myDate = new Date();
			$("#dateResult .con .date").text(NYR(myDate, 1));
			$("#dateResult .con .week").text(getDayInWeek(myDate));
			$("#train_date").val(NYR(myDate, 1));
			dateMobiscroll = $("#dateResult").mobiscroll().calendar({
				min: myDate,
				dateFormat: 'yy-mm-dd',
				onSet: function(val, obj) {
					val = val.valueText;
					$("#dateResult .con .date").text(NYR(val, 1));
					$("#dateResult .con .week").text(getDayInWeek(new Date(val)));
					$("#train_date").val(val);
				}
			});
		}

		function getApply() {
			var str = '<li data-val="无" data-id="0" data-begin="0" data-end="0" >无</li>';
			appcan.request.ajax({
				url: httpHost + 'travelApplyController.do?queryForExp',
				type: 'POST',
				dataType: 'json',
				beforeSend: addHeader,
				success: function(data) {
					objson = data;
					appcan.window.closeToast();
					if(objson.success) {
						for(var i = 0; i < objson.obj.length; i++) {			
							var text = objson.obj[i].reason;
							var id = objson.obj[i].id;
							var begin = objson.obj[i].begin;
							var end = objson.obj[i].end;
							var from = objson.obj[i].from;
							var to = objson.obj[i].to;
							var span = '<span class="s-date">(' + NYR(begin, 1) + '~' + NYR(end, 1) + ')</span>';
							str += '<li data-val=' + text + (i + 1) + ' data-id=' + id + ' data-begin=' + begin + ' data-end=' + end + ' data-from=' + from + ' data-to=' + to + '>' + text + span + '</li>';
						}
						$("#selectUl").html(str);
						selectMobiscroll = $("#selectUl").mobiscroll().treelist({
							defaultValue: [0],
							onSet: function(val, obj) {
								val = val.valueText;
								if(val === "无") {
									init()
									return;
								}
								getSelect(val);
								$("#selectUl_dummy").val(val.replace(/\d+/g, ''));
							}
						});
						$("#selectUl_dummy").val('无');
					} else {
						if(objson.msg == "用户未登录") {
							reLogin(getApply);
						} else {
							selectMobiscroll = $("#selectUl").mobiscroll().treelist();
							$("#selectUl_dummy").val("无");
							//appcan.window.openToast(objson.msg, 2000);
						}
					}
				},
				error: function(e, err) {}
			});
		}

		function getSelect(val) {
			$('#selectUl li').each(function() {
				if($(this).data('val') == val) {
					var self = $(this);
					for(var key in stations) {
						if(key === self.data("from").replace(/市/g, "")) {
							$("#from_city").text(self.data("from").replace(/市/g, ""));
							appcan.locStorage.setVal("from_station_city", key)
							appcan.locStorage.setVal("from_station", stations[key]);
						} else if(key === self.data("to").replace(/市/g, "")) {
							$("#to_city").text(self.data("to").replace(/市/g, ""));
							appcan.locStorage.setVal("to_station_city", key);
							appcan.locStorage.setVal("to_station", stations[key]);
						}
					}
					mySelect.begin = self.data('begin');
					mySelect.end = self.data('end');
					mySelect.id = self.data('id');
					setStartTime(self);
				}
			});
		}

		function setStartTime(obj) {
			var str = obj.data("begin");
			appcan.locStorage.setVal("beginDate", str);
			var str1 = obj.data("end");
			if(str == '0' || str1 == '0') {
				init();
				return;
			};
			var date = new Date(str),
				date1 = new Date(str1);
			if(date.getTime() < (new Date()).getTime()) {
				date = new Date();
			}
			$("#train_date").val(NYR(date, 1));
			$("#dateResult .con .date").text(NYR(date, 1));
			$(".tx_red").text(NYR(date, 3));
			dateMobiscroll = $("#dateResult").mobiscroll().date({
				min: date,
				max: date1,
				dateFormat: 'yy-mm-dd',
				onSet: function(val, obj) {
					val = val.valueText;
					$("#dateResult .con .date").text(NYR(val, 1));
					$("#dateResult .con .week").text(getDayInWeek(new Date(val)));
					$("#train_date").val(val);
				}
			})
		}

		function setFromCity(cityName) {
			var city = cityName.split(",")[0];
			var cityNode = cityName.split(",")[1];
			$("#from_city").text(city);
			appcan.locStorage.setVal("from_station", cityNode);
			appcan.locStorage.setVal("from_station_city", city);
		}

		function setToCity(cityName) {
			var city = cityName.split(",")[0];
			var cityNode = cityName.split(",")[1];
			$("#to_city").text(city);
			appcan.locStorage.setVal("to_station", cityNode);
			appcan.locStorage.setVal("to_station_city", city);
		}

		function closeMobiscroll() {
			dateMobiscroll.mobiscroll('hide');
			selectMobiscroll.mobiscroll('hide');
		}

		function searchTrain() {
			appcan.locStorage.setVal("train_date", $("#train_date").val());
			appcan.locStorage.setVal("train_applyId", mySelect.id);
			appcan.window.open("train_ticket_searchresult", "train_ticket_searchresult.html", 2);
			closeMobiscroll();
		}
	</script>

</html>