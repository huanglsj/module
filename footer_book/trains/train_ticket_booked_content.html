<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">

	<head>
		<title></title>
		<meta charset="utf-8">
		<meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link rel="stylesheet" href="../../css/ui-box.css">
		<link rel="stylesheet" href="../../css/ui-base.css">
		<link rel="stylesheet" href="../../css/ui-color.css">
		<link rel="stylesheet" href="../../css/appcan.icon.css">
		<link rel="stylesheet" href="../../css/appcan.control.css">
		<link rel="stylesheet" href="../../css/main.css" />
		<link rel="stylesheet" href="train_ticket_booked_content/css/main.css">

	</head>

	<body class="um-vp sc-bg-active" ontouchstart>
		<div class="ub ub-ver uinn-a3 sc-text">
			<div class="user-blue sc-text-hint ub ub-ver header-bg">
				<div id="show" class="ub ub-ac train-book-head">
					<div class="ub ub-ver ub-ae umar-l2 umar-t ub-f1 t-left">
						<div class="small">始发站</div>
						<div id="fTrain" class="float-r user-ulev1 big big-txt ut-s">广州火车站</div>
						<div class="small">出发时间</div>
						<div class="float-r user-ulev1 ub">
						    <div id="sTime" class="biged"></div>
						    <div class="small s-left" id="sDate">
						        <div class="t-date"></div>
						        <div class="t-week"></div>
						    </div>
						</div>
					</div>
					<div class="train-b-center t-center ub ub-ver" id="stopInfo">
						<div class="ub-img res-stopImg" id="trainCode"></div>
						<div class="ulev-1 center uinn-at2">经停信息</div>
					</div>
					<div class="uinn-l1 ub ub-ver umar-r2 umar-t ub-f1 t-right">
						<div class="small">终点站</div>
						<div id="tTrain" class="user-ulev1 big big-txt ut-s">上海虹桥站</div>
						<div class="small">到站时间</div>
						<div class="user-ulev1 ub">
						    <div id="aTime" class="biged"></div>
                            <div class="small s-left" id="aDate">
                                <div class="t-date"></div>
                                <div class="t-week"></div>
                            </div>
						</div>
					</div>
				</div>
			</div>

			<ul class="train-book-ul" id="trainSeatList" v-cloak>
				<li v-for='item in items'>
					<div class="ub ub-ac">
						<div class="type">{{item.name}}</div>
						<div class="num" v-if="parseInt(item.num)*1>0">{{item.num}}张</div>
						<div class="num" v-else>{{item.num}}</div>
						<div class="money">{{item.price}}</div>
						<div class="buy gray" v-if="item.num=='无'">预订</div>
						<div class="buy reserve" v-else v-on:click="reserve(item)">预订</div>
					</div>
				</li>
			</ul>
		</div>
	</body>
	<script src="../../js/appcan.js"></script>
	<script src="../../js/appcan.control.js"></script>
	<script src="../../js/calendar.js"></script>
	<script src="../../js/common.js"></script>
	<script src="../../js/vue.min.js"></script>
	<script>
		var from_station_no;
		var seat_types;
		var to_station_no;
		var station_train_code;
		var from_station_name;
		var to_station_name;
		var start_time;
		var arrive_time;
		var train_date;
		var train_no;
		var yp_info;
		var secretStr;
		var seatItem;

		function buildParamData() {
			var query_fromCity = appcan.locStorage.getVal("from_station_city"); //查询的出发城市
			var query_toCity = appcan.locStorage.getVal("to_station_city"); //查询的到达城市
			var params = {
				query_from_station_name: query_fromCity,
				query_to_station_name: query_toCity,
				secretStr: secretStr,
				train_date: train_date
			}
			var data_params = {
				params: params
			}
			appcan.locStorage.setVal("data_params", data_params);

			var userForm = {
				"params['query_from_station_name']": query_fromCity,
				"params['query_to_station_name']": query_toCity,
				"params['secretStr']": secretStr,
				"params['train_date']": train_date
			};
			return userForm;
		}

		function bookTicket() {
			var userForm = buildParamData();
			addMask("../../img/loading.gif", "提交中,请稍后");
			appcan.request.ajax({
				url: httpHost + 'trainController.do?bookTicket',
				type: 'POST',
				timeout: 20000,
				beforeSend: addHeader,
				data: userForm,
				success: function(data) {
					var dt = eval("(" + data + ")");
					console.log(dt);
					if(dt.success) {
						if(dt.obj.relogin != undefined) {
							appcan.window.open("login_12306", "login_12306.html", 2);
						} else {
							data = eval("(" + data + ")");
							appcan.locStorage.setVal("result_datas", data.obj);
							appcan.window.open("train_ticket_bookdetails", "train_ticket_bookdetails.html", 0);
						}
					} else {
					    if(dt.msg=="用户未登录"){
                          reLogin(bookTicket);
                        }else{
                            if(dt.msg.indexOf("未处理的订单") >= 0) {
                                appcan.window.openToast(dt.msg, 3000);
                                // alert(dt.msg)
                                // var trainOrderDetail=appcan.locStorage.getVal("trainOrderDetail");
                                // if(trainOrderDetail){//如果已经在本地预订了车票
                                    // appcan.window.confirm({
                                        // title: '提示',
                                        // content: dt.msg,
                                        // buttons: ['确认'],
                                        // callback: function(err, data, dataType, optId) {
                                            // if(data==0){
                                                // appcan.window.open("orderDetail","orderDetail.html",2);
                                            // }
                                        // }
                                    // });
//                                     
                                // }else{
//                                     
                                // }
                            }  
                        }
					}
					removeMask();
				},
				error: function(e, err) {
					self.lock = false;
					appcan.window.closeToast();
				}
			});

		}
		appcan.ready(function() {
			from_station_no = appcan.locStorage.getVal("from_station_no");
			seat_types = appcan.locStorage.getVal("seat_types");
			to_station_no = appcan.locStorage.getVal("to_station_no")
			station_train_code = appcan.locStorage.getVal("station_train_code");
			from_station_name = appcan.locStorage.getVal("from_station_name");
			to_station_name = appcan.locStorage.getVal("to_station_name");
			start_time = appcan.locStorage.getVal("start_time");
			arrive_time = appcan.locStorage.getVal("arrive_time");
			train_date = appcan.locStorage.getVal("train_date");
			train_no = appcan.locStorage.getVal("train_no");
			yp_info = appcan.locStorage.getVal("yp_info");
			secretStr = appcan.locStorage.getVal("secretStr");
			$("#fTrain").html(appcan.locStorage.getVal("from_station_name"));
			$("#tTrain").html(appcan.locStorage.getVal("to_station_name"));
			$("#trainCode").html(appcan.locStorage.getVal("station_train_code"));
			$("#sTime").html(appcan.locStorage.getVal("start_time"));
			$("#aTime").html(appcan.locStorage.getVal("arrive_time"));
			$(".f-white").html(appcan.locStorage.getVal("train_date"));
			$("#sDate .t-date").text(NYR(appcan.locStorage.getVal("start_train_date"),2));
			$("#sDate .t-week").text(NYR(appcan.locStorage.getVal("start_train_date"),3));
			$("#aDate .t-date").text(NYR(appcan.locStorage.getVal("arrive_train_date"),2));
            $("#aDate .t-week").text(NYR(appcan.locStorage.getVal("arrive_train_date"),3));

			forSeatList();

		});
		
		appcan.button("#stopInfo","btn-act",function(){
		    appcan.window.open("stop_info", "stop_info.html", 2);
		})

		function forSeatList() {
			var showAryAll = appcan.locStorage.getVal("showAry");
			var thisSeatAry = eval('(' + showAryAll + ')');
			var app = new Vue({
				el: '#trainSeatList',
				data: {
					items: thisSeatAry,
				},
				methods: {
					reserve: function(item) {
						appcan.locStorage.setVal("seatItem", item);
						var applyId = appcan.locStorage.getVal("train_applyId");
						if(applyId==0){
						    appcan.window.openToast('请您先选择出差申请再预订', 2000);
						    return;
						}
						bookTicket();
					}
				}
			})
		}
	</script>

</html>