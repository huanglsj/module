<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">

	<head>
		<title></title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link rel="stylesheet" href="../../css/fonts/font-awesome.min.css">
		<link rel="stylesheet" href="../../css/mobiscroll.min.css">
		<link rel="stylesheet" href="../../css/ui-box.css">
		<link rel="stylesheet" href="../../css/ui-color.css">
		<link rel="stylesheet" href="../../css/appcan.icon.css">
		<link rel="stylesheet" href="../../css/appcan.control.css">
		<link rel="stylesheet" href="../../css/mymedia.css">
		<link rel="stylesheet" href="train_ticket_searchresult_content/css/main.css">
	</head>

	<body class="um-vp" style="background-color: #F4F4F4" ontouchstart>

		<div id="msgError"></div>
		<ul class="train-ticket-ul" id="trainTicketlist" v-cloak>
			<li v-for='item in items' v-on:click="openNext(item)">
				<div class="train-ticket-h ub">
					<div class="td">
						<div class="deep">{{item.start_time}}</div>
						<div class="top">{{item.from_station_name}}</div>
					</div>
					<div class="td">
						<div class="icon">{{item.station_train_code}}</div>
						<div class="green top">{{item.lishi}}</div>
					</div>
					<div class="td">
						<div class="deep">{{item.arrive_time}}</div>
						<div class="top">{{item.to_station_name}}</div>
					</div>
					<div class="td ub ub-pe ub-ac">
						<div class="yellow">￥{{item.minPrice}}</div>
						<div class="small">起</div>
					</div>
				</div>
				<div class="train-ticket-f">
					<div class="ub" v-if="is">
						<div class="ub ub-f1 td">二等座：{{item.ze_num}}</div>
						<div class="ub ub-f1 td ub-pc">一等座：{{item.zy_num}}</div>
						<div class="ub ub-f1 td ub-pe">商务座：{{item.swz_num}}</div>
					</div>
					<div v-else>
						<div class="ub" v-if="item.station_train_code.charAt(0).toUpperCase()=='D' || item.station_train_code.charAt(0).toUpperCase()=='G'">
							<div class="ub ub-f1 td">二等座：{{item.ze_num}}</div>
							<div class="ub ub-f1 td ub-pc">一等座：{{item.zy_num}}</div>
							<div class="ub ub-f1 td ub-pe">商务座：{{item.swz_num}}</div>
						</div>
						<div class="ub train-ticket-p" v-else>
							<div class="ub ub-f1 td">无座：{{item.wz_num}}</div>
							<div class="ub ub-f1 td ub-pc">硬座：{{item.yz_num}}</div>
							<div class="ub ub-f1 td ub-pc">硬卧：{{item.yw_num}}</div>
							<div class="ub ub-f1 td ub-pe">软卧：{{item.rz_num}}</div>
						</div>
					</div>
				</div>
			</li>
		</ul>
		<input type="hidden" id="calendarHidden" />
	</body>
	<script src="../../js/jquery.min.js"></script>
	<script src="../../js/appcan.js"></script>
	<script src="../../js/appcan.control.js"></script>
	<script src="../../js/layer/layer.js"></script>
	<script src="../../js/mobiscroll.min.zh.js"></script>
	<script src="../../js/common.js"></script>
	<script src="../../js/vue.min.js"></script>
	<script>
		var from_station;
		var to_station;
		var train_date;

		appcan.ready(function() {
			appcan.window.evaluateScript({
				name: 'train_ticket_searchresult',
				scriptContent: 'preventClick()'
			});
			freshData(); //初始化加载
		});
		var row = {
			swz_num: "商务座",
			tz_num: "特等座",
			zy_num: "一等座",
			ze_num: "二等座",
			gr_num: "高级软卧",
			rw_num: "软卧",
			yw_num: "硬卧",
			rz_num: "软座",
			yz_num: "硬座",
			wz_num: "无座",
			qt_num: "其他"
		};
		// 特等座：P 商务座:9 一等座：M 二等座：O  硬卧：3 硬座：1 软卧：4 高级软卧：6 软座：2,其他（要么是1，要么是O）
		var trainType_mapper = ["9", "P", "M", "O", "6", "4", "3", "2", "1"];
		//swz:"商务座",tz:"特等座",zy:"一等座",ze:"二等座",gr:"高级软卧",rw:"软卧",yw:"硬卧",rz:"软座",yz:"硬座",wz:"无座",qt:"其他"
		var ary = ["swz", "tz", "zy", "ze", "gr", "rw", "yw", "rz", "yz", "wz", "qt"];
		var NUMCODE = "_num";
		var PRICECODE = "_price_str";
		from_station = appcan.locStorage.getVal("from_station");
		to_station = appcan.locStorage.getVal("to_station");
		train_date = appcan.locStorage.getVal("train_date");
		$("#calendarHidden").val(train_date);
		$("#today").html(appcan.locStorage.getVal("train_date"));
		var app = new Vue({
			el: '#trainTicketlist',
			data: {
				items: [],
				type: row,
				is: false
			},
			methods: {
				openNext: function(item) {
					appcan.setLocVal('trainDetail', item);
					if((item.yz_num != "--") && (item.yz_num != "无")) {
						item.thisMinPrice = item.yz_price_str;
					} else if((item.yz_num == "--") && (item.ze_num != "--")) {
						item.thisMinPrice = item.ze_price_str;
					}
					
					appcan.locStorage.setVal("location_code",item.location_code);
					appcan.locStorage.setVal("from_station_no", item.from_station_no);
					appcan.locStorage.setVal("to_station_no", item.to_station_no);
					appcan.locStorage.setVal("from_station_name", item.from_station_name);
					appcan.locStorage.setVal("to_station_name", item.to_station_name);
					appcan.locStorage.setVal("station_train_code", item.station_train_code);
					appcan.locStorage.setVal("start_time", item.start_time);
					appcan.locStorage.setVal("arrive_time", item.arrive_time);
					appcan.locStorage.setVal("seat_types", item.seat_types);
					appcan.locStorage.setVal("train_no", item.train_no);
					appcan.locStorage.setVal("minPrice", item.minPrice);
					appcan.locStorage.setVal("yp_info", item.yp_info);
					appcan.locStorage.setVal("secretStr", item.secretStr);
					appcan.locStorage.setVal("from_station_telecode", item.from_station_telecode);
					appcan.locStorage.setVal("to_station_telecode", item.to_station_telecode);
					appcan.locStorage.setVal("start_train_date", appcan.locStorage.getVal("train_date"));
					appcan.locStorage.setVal("arrive_train_date", item.arrive_train_date);

					var showAry = new Array();
					for(var i = 0; i < ary.length; i++) {
						var seat_num_key = ary[i] + NUMCODE;
						var seat_price_key = ary[i] + PRICECODE;
						var value_num = item[seat_num_key];
						var value_price = item[seat_price_key];
						var seat_name = ary[i] + "_name";
						if(value_num != '--') {
							var showRow = new Object();
							showRow["num"] = value_num;
							showRow["price"] = value_price;
							showRow["name"] = row[seat_num_key];
							showRow["seatType"] = trainType_mapper[i];
							showAry.unshift(showRow);
						}
					}
					appcan.locStorage.setVal("showAry", showAry);
					appcan.window.open("train_ticket_booked", "train_ticket_booked.html", 2);
				},
			},
		});

		var pm = {
			"params['from_station']": from_station,
			"params['to_station']": to_station,
			"params['train_date']": train_date,
			"params['purpose_codes']": "ADULT"
		};

		function freshData() {
			ajaxRequest({
				url: httpHost + 'trainController.do?queryTrain',
				beforeSend: addHeader,
				data: pm,
				type: "POST",
				dataType: 'json',
				success: function(data) {
					var objson = data;
					$("#msgError").html('');
					appcan.window.evaluateScript({
						name: 'train_ticket_searchresult',
						scriptContent: 'outMask()'
					});
					if(objson.success) {
						var arrData = objson.obj;
						appcan.locStorage.setVal("listLength", arrData.length);
						var isDongche = appcan.locStorage.getVal("isDongche");
						app.items = [];
						if(isDongche == "true") {
							for(var i = 0; i < arrData.length; i++) {
								var name = arrData[i].station_train_code;
								var firstN = name.charAt(0).toUpperCase();
								if((firstN == "D") || (firstN == "G")) {
									$("#trainTicketlist").show();
									$("#msgError").html('');
									app.items.push(arrData[i]);
									app.is = true;
								} else {
									$("#trainTicketlist").hide();
									$("#msgError").html('<div class="sc-text-top tx-c" style="color:#3B5999;margin-top:1em;" id="msgError">抱歉，未帮您找到符合条件的车票!</div>');
								}
							}
						} else {
							for(var obj in arrData) {
								$("#trainTicketlist").show();
								$("#msgError").html('');
								app.is = false;
								app.items.push(arrData[obj]);
							}
						}
						return;
					} else {
						appcan.locStorage.setVal("listLength", "0");
						if(data.msg == "用户未登录") {
							reLogin(freshData);
						} else if(objson.msg == null) {
							$("#trainTicketlist").hide();
							$("#msgError").html('<div class="sc-text-top tx-c" style="color:#3B5999;margin-top:1em;" id="msgError">抱歉，未帮您找到符合条件的车票!</div>');
						} else {
							$("#trainTicketlist").hide();
							$("#msgError").html('<div class="sc-text-top tx-c" style="color:#3B5999;margin-top:1em;" id="msgError">' + objson.msg + '</div>');
						}

					}
				},
				error: function(e, err) {
					appcan.window.evaluateScript({
						name: 'train_ticket_searchresult',
						scriptContent: 'outMask()'
					});
				}
			}, '../../img/loading.gif');

		}

		function prevDay() {
			var myDate = appcan.locStorage.getVal("train_date");
			var dateText = asDay(new Date(myDate), 1, 1);
			var curDate = new Date();
            var poor = (new Date(dateText).getTime() - (new Date(NYR(curDate,1))).getTime());
			if(poor >= 0) {
				appcan.window.evaluateScript({
					name: 'train_ticket_searchresult',
					scriptContent: 'setDate("' + dateText + '")'
				});
				appcan.locStorage.setVal("train_date", dateText);
				train_date = dateText;
				pm = {
					"params['from_station']": from_station,
					"params['to_station']": to_station,
					"params['train_date']": train_date,
					"params['purpose_codes']": "ADULT"
				};
				appcan.window.evaluateScript({
					name: 'train_ticket_searchresult',
					scriptContent: 'preventClick()'
				});
				$("#calendarHidden").val(dateText);
				freshData();
			} else {
				layer.open({
					content: '不能选择小于今天的日期',
					skin: 'msg',
					time: 2
				});
			}
		}

		function nextDay() {
			var myDate = appcan.locStorage.getVal("train_date");
			var dateText = asDay(new Date(myDate), 1, 0);
			appcan.window.evaluateScript({
				name: 'train_ticket_searchresult',
				scriptContent: 'setDate("' + dateText + '")'
			});
			appcan.locStorage.setVal("train_date", dateText);
			train_date = dateText;
			pm = {
				"params['from_station']": from_station,
				"params['to_station']": to_station,
				"params['train_date']": train_date,
				"params['purpose_codes']": "ADULT"
			};
			appcan.window.evaluateScript({
                    name: 'train_ticket_searchresult',
                    scriptContent: 'preventClick()'
            });
			$("#calendarHidden").val(dateText);
			freshData();
		}

		var calendarShow;

		function showCalendar() {
			var today = $("#calendarHidden").val();
			appcan.window.evaluateScript({
                 name: 'train_ticket_searchresult',
                 scriptContent: 'preventClick()'
            });
			calendarShow = $("#calendarHidden").mobiscroll().calendar({
				min: new Date(),
				dateFormat: 'yy-mm-dd',
				defaultValue: new Date(today),
				onCancel: function(val, obj) {
				    appcan.window.evaluateScript({
                        name: 'train_ticket_searchresult',
                        scriptContent: 'outMask()'
                    });
				},
				onSet: function(val, obj) {
					val = val.valueText;
					$("#calendarHidden").val(val);
					appcan.locStorage.setVal("train_date", val);
					appcan.window.evaluateScript({
						name: 'train_ticket_searchresult',
						scriptContent: 'setDate("' + val + '")'
					});
					pm = {
						"params['from_station']": from_station,
						"params['to_station']": to_station,
						"params['train_date']": val,
						"params['purpose_codes']": "ADULT"
					};
					freshData();
				}
			});
			calendarShow.mobiscroll("show");
		}
	</script>

</html>